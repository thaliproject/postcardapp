<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="/elements/behaviors/button-listeners.html">
<link rel="import" href="/elements/behaviors/tree-traversing.html">
<link rel="import" href="/elements/behaviors/path-components.html">
<link rel="import" href="/elements/behaviors/multi-platform.html">

<dom-module id="page-home">

<template>
  <iron-ajax url="/api/cards" last-response="{{listData}}" on-response="_onResponseReceived"></iron-ajax>
  <iron-selector attr-for-selected="index" on-click="_itemSelected">
    <iron-list id="my-postcards" items="{{listData.rows}}" as="item" class="fit">
      <template>
        <paper-card id="{{index}}" class="row">
          <div class="card-content postcard">
            <span>[[_humanizeDate(item.doc.dateCreated)]]</span>
            <pre>{{item.doc.text}}</pre>
            <p>[[item.doc.author]]</p>
            <paper-fab id="{{item.doc._id}}" icon="delete" class="FAB" hidden></paper-fab>
          </div>
        </paper-card>
      </template>
    </iron-list>
  </iron-selector>
  <aside id="placeholder" class="fit layout vertical center-center" hidden>
    <div>
      <paper-button class="postcard" raised on-click="_addCard"><iron-icon icon="add"></iron-icon>Create postcard</paper-button>
      <div class="gutter"></div>
    </div>
  </aside>
</template>

<script>
'use strict';
Polymer({
  is: "page-home",
  behaviors: [
      PageBehaviors.ButtonListeners, 
      PageBehaviors.TreeTraversing,
      PageBehaviors.PathComponents,
      PageBehaviors.MultiPlatform
    ],
  properties: {
    listData: {
      type: Object,
      notify: true
    },
    addButton: Object,
    refreshButton: Object,
    deleteButton: Object,
    _isEditMode: false,
    _isLoaded: false
  },
  listeners: {
    'card-changed': 'cardChangedHandler'
  },
  created: function() {
    console.log(this.localName + ' was created');
  },
  ready : function() {
    console.log(this.localName + ' ready');
  },
  attached: function() {
    console.log(this.localName + ' was attached');
  },
  detached: function() {
    console.log(this.localName + ' was detached');
  },
  viewWillAppear: function() {
    console.log(this.localName + ' viewWillAppear');
    this.activate();
    myApp.title = "Postcards";
    if(myApp.discoverButton) {
      myApp.discoverButton.removeAttribute("hidden");
    }
    // load data on first run then content should auto-refresh
    if (!this._isLoaded) {
      this._reloadData();
    } else {
      this._updateUserView(); // shows delete button (if needed) when back pressed
    }
  },
  viewWillDisappear: function() {
    console.log(this.localName + ' viewWillDisappear');
    this.deactivate();
    // reset state
    this._isEditMode = false;
    this._updateListMode();
  },
  activate: function() {
    console.log(this.localName + " activate... active status:" + this._isActivated);

    this.addButton = document.querySelector("#addButton");
    this.deleteButton = document.querySelector("#deleteButton");

    var toolbarButtonArray = [this.addButton, this.deleteButton];
    var toolbarFunctionArray = [this._addCard, this._toggleEditMode.bind(this)];
    this.activateButtons(toolbarButtonArray, toolbarFunctionArray);
  },
  deactivate: function() {
    console.log(this.localName + " deactivate... active status:" + this._isActivated);
    this.deactivateButtons([this.addButton, this.deleteButton]);
  },
  _humanizeDate: function(date) {
    return moment.utc(date,'x').fromNow();
  },
  _addCard: function(e) {
    console.log("add card: " + e);
    getURL("editor");
  },
  _reloadData: function(e) {
    console.log("*** RELOAD DATA... ***");
    this._generateRequest();
  },

  // enable editting for selected postcard 
  _itemSelected: function(e) {
    var selectedIndex = this.getParentAttribute(e.target, 'paper-card', 'id');
    var cardId = this.getParentAttribute(e.target, 'paper-fab', 'id');
    var isInput = this.getParentElement(e.target, "input");
    var isDelete = this.getParentElement(e.target, "paper-fab");
    if (!isInput && !isDelete) {
      console.log("_itemSelected: " + selectedIndex);
      if(selectedIndex!==false && selectedIndex>=0){
        getURL("editor/"+selectedIndex);
      }
    } else if ( isDelete ) {
      document.activeElement.blur(); // should dismiss iOS keyboard
      this._deleteCard(selectedIndex, cardId); // delete selected card
    }
  },

  // delete card
  _deleteCard: function(index, cardId) {
    console.log("delete index #" + index + " cardId:" + cardId);
    var self = this;
    $.ajax({
        url: myApp.url + cardId,
        type: 'DELETE',
        error: function(jqXHR, textStatus, errorThrown) {
          console.log('@ error in delete Card ' + JSON.stringify(jqXHR) + ' ' + textStatus + ' ' + errorThrown);
          alert("Error deleting card");
        },
        success: function(data, textStatus, jqXHR) {
          console.log("@ deleted Card - " + textStatus);
          console.log(data);
          // if 'ok' update client UI else alert user with error
          if(data.ok && data.ok===true) {
            self.splice('listData.rows', index, 1);
            self._updateUserView(); // update user view after delete
          } else {
            alert("Delete card error");
          }
        }
    });
  },

  // iron-ajax request
  _generateRequest: function() {
    this.querySelector("iron-ajax").generateRequest();
  },

  // iron-ajax response
  _onResponseReceived: function () {
      console.log("_onResponseReceived");
      console.log(this.listData);

      if(!this.listData || !this.listData.rows || this.listData.total_rows==0 ) {
        alert("Error. Peer session expired or failed to get any data."); // Reset app
        return;
      }

      console.log("listData offset:" + this.listData.offset + " total_rows:" + this.listData.total_rows );

      // splice out 'me' record
      if(this.listData.rows.length>0) {
        var row;
        for(var i=0; i<this.listData.rows.length; i++) {
          row = this.listData.rows[i];
          if(row.id === 'me') {
            console.log("me:" + row.doc.user);
            this.splice('listData.rows',i,1);
            break;
          }
        }
      }

      //sort records by date created
      this.set('listData.rows', _.sortBy(this.listData.rows, function(o){
        return -o.doc.dateCreated;
      } 
      ));

      this._isLoaded = true;
      this._updateUserView();
  },
  
  // toogle edit mode
  _toggleEditMode: function() {
    this._isEditMode = !this._isEditMode;
    console.log("toggle edit mode:",this._isEditMode);
    this._updateListMode();
  },

  _updateListMode: function() {
    var elements = this.querySelectorAll('.row');
    var isHidden = !this._isEditMode;
    for (var i=0; i<elements.length; i++) {
      var element = elements[i];
      var deleteButton = element.querySelector('paper-fab');
      this._setVisibility(deleteButton, isHidden);
    }
  },

  _setVisibility: function(element, isHidden) {
    if(isHidden) {
      element.setAttribute("hidden", true);
    } else {
      element.removeAttribute("hidden");
    }
  },

  // displays user prompt instead if no cards to display
  _updateUserView: function() {
    if (this.listData.rows.length>0) {
      this.querySelector("aside").setAttribute("hidden", true);
      this.querySelector('iron-list').removeAttribute("hidden");
      this.deleteButton.removeAttribute("hidden");
    } else {
      console.log("prompt user to go create a postcard!");
      this.querySelector("aside").removeAttribute("hidden");
      this.querySelector('iron-list').setAttribute("hidden", true);
      this.deleteButton.setAttribute("hidden", true);
    }   
  },

  cardChangedHandler: function(e) {
    console.log("cardChangedHandler");
    console.log(e);
    this._reloadData();
  }

});
</script>
</dom-module>